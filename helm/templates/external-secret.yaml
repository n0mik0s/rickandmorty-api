# ExternalSecret
#
# Reads the full secrets.json string from the Kubernetes Secret that CI created
# (eso-source-secret) and re-publishes it as a new Secret that the Deployment
# mounts as /etc/rickandmorty/secrets.json.
#
# Data flow:
#   GitHub Actions secret (RICKANDMORTY_DB_SECRET)
#     → kubectl apply → eso-source-secret  (key: secrets.json)
#       → ESO SecretStore (Kubernetes provider)
#         → ExternalSecret sync
#           → rickandmorty-db-secret       (key: secrets.json)
#             → volumeMount in pod         → /etc/rickandmorty/secrets.json
#
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ .Values.externalSecrets.externalSecret.name }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "rickandmorty-api.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.externalSecret.refreshInterval }}

  secretStoreRef:
    kind: SecretStore
    name: {{ .Values.externalSecrets.secretStore.name }}

  target:
    name: {{ .Values.externalSecrets.externalSecret.targetSecretName }}
    creationPolicy: Owner          # ESO owns the Secret lifecycle
    deletionPolicy: Retain         # keep the Secret if the ExternalSecret is deleted

  data:
    - secretKey: {{ .Values.externalSecrets.sourceSecretKey | quote }}
      remoteRef:
        key: {{ .Values.externalSecrets.sourceSecretName | quote }}
        property: {{ .Values.externalSecrets.sourceSecretKey | quote }}