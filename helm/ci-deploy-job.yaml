# ─────────────────────────────────────────────────────────────────────────────
# GitHub Actions — deploy job snippet
#
# Add this job to your existing ci-cd.yml AFTER the push-image job.
# It shows exactly how to push the GitHub Actions secret into Kubernetes
# before Helm runs, so ESO can pick it up.
#
# Required GitHub Actions secrets:
#   RICKANDMORTY_DB_SECRET  — full secrets.json content, e.g.:
#                             {"host":"pg","user":"u","password":"p","dbname":"rickandmorty"}
#   KUBECONFIG_DATA         — base64-encoded kubeconfig for the target cluster
# ─────────────────────────────────────────────────────────────────────────────

  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: push-image
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    env:
      NAMESPACE: rickandmorty

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: "latest"

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Ensure namespace exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      # ── KEY STEP: push the GitHub Actions secret into Kubernetes ──────────
      # This creates (or updates) the Kubernetes Secret that ESO reads from.
      # The secret variable holds the complete secrets.json JSON string.
      - name: Push DB secret into Kubernetes for ESO
        run: |
          kubectl create secret generic eso-source-secret \
            --from-literal=secrets.json='${{ secrets.RICKANDMORTY_DB_SECRET }}' \
            --namespace ${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      # ── Helm deploy ───────────────────────────────────────────────────────
      - name: Helm upgrade / install
        run: |
          helm upgrade --install rickandmorty-api ./helm/rickandmorty-api \
            --namespace ${{ env.NAMESPACE }} \
            --set image.tag=sha-${{ github.sha }} \
            --wait \
            --timeout 5m

      # ── Verify ESO synced the secret ─────────────────────────────────────
      - name: Wait for ExternalSecret to sync
        run: |
          kubectl wait externalsecret rickandmorty-db-secret \
            --for=condition=Ready \
            --namespace ${{ env.NAMESPACE }} \
            --timeout=60s