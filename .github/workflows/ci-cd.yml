name: CI/CD Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/rickandmorty-api
  APP_DIR: .

jobs:
  # ─────────────────────────────────────────────
  # 1. Code Quality
  # ─────────────────────────────────────────────
  lint-and-security:
    name: Lint & Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        working-directory: ${{ env.APP_DIR }}
        run: uv sync --all-extras

      # Ruff covers both linting and formatting checks
      - name: Lint with Ruff
        working-directory: ${{ env.APP_DIR }}
        run: uv run ruff check . --output-format=github

      - name: Format check with Ruff
        working-directory: ${{ env.APP_DIR }}
        run: uv run ruff format --check .

      # Static type checking
      - name: Type check with mypy
        working-directory: ${{ env.APP_DIR }}
        run: uv run mypy main.py --ignore-missing-imports
        continue-on-error: true   # advisory; flip to false to enforce

      # Security: dependency vulnerabilities
      - name: Security scan with pip-audit
        working-directory: ${{ env.APP_DIR }}
        run: uv run pip-audit

      # Security: source-code patterns (secrets, hardcoded creds, etc.)
      - name: Security scan with Bandit
        working-directory: ${{ env.APP_DIR }}
        run: uv run bandit -r main.py -c pyproject.toml -ll

  # ─────────────────────────────────────────────
  # 2. Unit Tests
  # ─────────────────────────────────────────────
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-security

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        working-directory: ${{ env.APP_DIR }}
        run: uv sync --all-extras

      # Provide dummy config/secret files so the module-level argparse
      # does not fail during import inside the test suite.
      - name: Create dummy config files
        run: |
          mkdir -p tmp
          echo '{"user":"test","password":"test","host":"localhost","dbname":"testdb"}' > tmp/secrets.json
          printf 'log_level: INFO\n' > tmp/config.yaml

      - name: Run unit tests
        working-directory: ${{ env.APP_DIR }}
        env:
          CONFIG_PATH: ../tmp/config.yaml
          SECRET_PATH: ../tmp/secrets.json
        run: |
          uv run pytest tests/unit/ \
            --tb=short \
            -v \
            --cov=main \
            --cov-report=xml \
            --cov-report=term-missing

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ${{ env.APP_DIR }}/coverage.xml
          fail_ci_if_error: false

  # ─────────────────────────────────────────────
  # 3. Build & Test Docker Image
  # ─────────────────────────────────────────────
  build-and-test:
    name: Build & Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (local, no push)
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.APP_DIR }}
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ── Scan the built image for OS/package CVEs ──
      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}:test
          format: table
          exit-code: 1            # fail on CRITICAL vulnerabilities
          severity: CRITICAL
          ignore-unfixed: true

      # ── Spin up the app container for integration tests ──
      - name: Create runtime config files
        run: |
          mkdir -p tmp
          cat > tmp/secrets.json <<'EOF'
          {"user":"testuser","password":"testpass","host":"localhost","dbname":"rickandmorty"}
          EOF
          printf 'log_level: INFO\n' > tmp/config.yaml

      - name: Run application container
        run: |
          docker run -d \
            --name app \
            --network host \
            -v ${{ github.workspace }}/tmp:/tmp/appconfig:ro \
            ${{ env.IMAGE_NAME }}:test \
            --config /tmp/appconfig/config.yaml \
            --secret /tmp/appconfig/secrets.json

      - name: Wait for application to be ready
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8000/docs > /dev/null 2>&1; then
              echo "App is up!"
              break
            fi
            echo "Waiting... attempt $i"
            sleep 3
          done

      - name: Install uv (for integration test runner)
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install

      - name: Install test dependencies
        working-directory: ${{ env.APP_DIR }}
        run: uv sync --all-extras

      - name: Run integration tests
        working-directory: ${{ env.APP_DIR }}
        env:
          API_BASE_URL: http://localhost:8000
          DB_HOST: localhost
          DB_USER: testuser
          DB_PASSWORD: testpass
          DB_NAME: rickandmorty
        run: |
          uv run pytest tests/integration/ \
            --tb=short \
            -v

      - name: Dump container logs on failure
        if: failure()
        run: docker logs app

  # ─────────────────────────────────────────────
  # 4. Push to Docker Hub
  # ─────────────────────────────────────────────
  push-image:
    name: Push to Docker Hub
    runs-on: ubuntu-latest
    needs: build-and-test
    # Only push on commits to the default branch (not on PRs)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      #- name: Set current date as environment variable
      #  run: echo "NOW=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata (tags & labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: type=raw,value=build-{{date 'YYYYMMDD-HHmm'}}-{{sha}}
          #tags: |
          #  type=sha,prefix=sha-
          #  type=ref,event=branch
          #  type=raw,value=build-${{ env.NOW }},enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.APP_DIR }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64